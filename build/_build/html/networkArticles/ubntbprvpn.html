<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ubiquiti Edgerouter VPN with Policy Based routing &mdash; MyLilServer.net  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Boot windows as KVM on serprate HDD" href="../unixArticles/windowsKVM.html" />
    <link rel="prev" title="Troubleshoot Fortigate IPsec VPN" href="fortissl.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            MyLilServer.net
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Networking Articles</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="timeout.html">Cisco AnyConnect idle timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="fortigateSipAlg.html">Disabling SIP-ALG on FortiOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="sshtunnel.html">HTTPS over SSH tunnels</a></li>
<li class="toctree-l1"><a class="reference internal" href="dhcp.html">IPv6 SLAAC and DHCP - Juniper</a></li>
<li class="toctree-l1"><a class="reference internal" href="jncissp.html">JNCIS-SP Study Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="mac.html">Mac network utility</a></li>
<li class="toctree-l1"><a class="reference internal" href="ubntservices.html">Manaing EdgeOS services</a></li>
<li class="toctree-l1"><a class="reference internal" href="sweep.html">Sweep network utility</a></li>
<li class="toctree-l1"><a class="reference internal" href="fortissl.html">Troubleshoot Fortigate IPsec VPN</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Ubiquiti Edgerouter VPN with Policy Based routing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-setup">The setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#side-a">Side A</a></li>
<li class="toctree-l2"><a class="reference internal" href="#side-b">Side B</a></li>
<li class="toctree-l2"><a class="reference internal" href="#side-b-complete-config">Side B complete config</a></li>
<li class="toctree-l2"><a class="reference internal" href="#resources">Resources</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Unix Articles</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../unixArticles/windowsKVM.html">Boot windows as KVM on serprate HDD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unixArticles/librenms.html">Librenms: Directly querying mysql database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unixArticles/openvpn.html">OpenVPN on Thirdlane PBX server for Yealink phones</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unixArticles/iperfxinitd.html">Starting Iperf3 remotely using xinitd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unixArticles/xnee.html">xnee/cnee mouse automation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Go articles</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../golang/smtprelay.html">Golang open smtp relay</a></li>
<li class="toctree-l1"><a class="reference internal" href="../golang/pingSweep.html">Pingsweep icmp sweep package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../golang/scrapligoDrivers.html">Scrapligo platform drivers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Windows articles</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../windowsArticles/clear_malwarebytes.html">Clearing Malwarebytes log</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Network notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../networkNotes/calix.html">Calix notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networkNotes/fortinet.html">Fortinet Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networkNotes/fs.html">FS switch notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networkNotes/mikrotik.html">Mirkotik notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networkNotes/ubiquiti.html">Ubiquiti Edgerouter notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networkNotes/uisp.html">Ubiquiti UISP notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networkNotes/wireshark.html">Wireshark notes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Unix Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../unixNotes/lxc.html">Linux Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unixNotes/thirdlane.html">Thirdlane PBX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unixNotes/virsh.html">Virsh notes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other projects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../otherProjects/media.html">Media</a></li>
<li class="toctree-l1"><a class="reference internal" href="../otherProjects/mylilserver.html">MyLilServer.net</a></li>
<li class="toctree-l1"><a class="reference internal" href="../otherProjects/billboard.html">Raspbery Pi Digital Billboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../otherProjects/resume.html">Resume</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MyLilServer.net</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Ubiquiti Edgerouter VPN with Policy Based routing</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/networkArticles/ubntbprvpn.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ubiquiti-edgerouter-vpn-with-policy-based-routing">
<h1>Ubiquiti Edgerouter VPN with Policy Based routing<a class="headerlink" href="#ubiquiti-edgerouter-vpn-with-policy-based-routing" title="Link to this heading"></a></h1>
<p>In this areticle we will be building a route based VPN, and then directing traffic towards that vpn using policy based routing.
We will be tyring to connect site A with site B (below.) We want site A to return traffic based on which interface it arives on.
We want site B to send traffic from 172.30.1.0/28 voe the VPN tunnel, and the rest out via the default route.</p>
<p>In a Policy based VPN, all traffic not matching the policy will be dropped, and a standard Route based VPN will send all traffic to the destination.
This setup allows secure traffic from trusted devices to traverse the tunnel, but does not stop all other traffic from reaching the same endpoint.</p>
<section id="the-setup">
<h2>The setup<a class="headerlink" href="#the-setup" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#Side A</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">Side</span> <span class="n">A</span>
<span class="n">Local</span> <span class="n">networks</span><span class="p">:</span> <span class="mf">192.168.10.0</span><span class="o">/</span><span class="mi">24</span>
<span class="n">Remote</span> <span class="n">networks</span><span class="p">:</span> <span class="mf">172.30.1.0</span><span class="o">/</span><span class="mi">24</span>
<span class="n">Local</span> <span class="n">interface</span><span class="p">:</span> <span class="mf">10.0.0.2</span>
<span class="n">Remote</span> <span class="n">interface</span><span class="p">:</span> <span class="mf">20.0.0.2</span>
<span class="n">PSK</span><span class="p">:</span> <span class="mi">7</span><span class="n">raJ5QAK9cKuHR9tQeG</span><span class="o">@</span>

<span class="c1">#Side B</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">Side</span> <span class="n">A</span>
<span class="n">Local</span> <span class="n">networks</span><span class="p">:</span> <span class="mf">172.30.1.0</span><span class="o">/</span><span class="mi">24</span> <span class="mi">1</span>
<span class="n">Remote</span> <span class="n">networks</span><span class="p">:</span> <span class="mf">92.168.10.0</span><span class="o">/</span><span class="mi">24</span>
<span class="n">Local</span> <span class="n">interface</span><span class="p">:</span> <span class="mf">20.0.0.2</span>
<span class="n">Remote</span> <span class="n">interface</span><span class="p">:</span> <span class="mf">10.0.0.2</span>
<span class="n">PSK</span><span class="p">:</span> <span class="mi">7</span><span class="n">raJ5QAK9cKuHR9tQeG</span><span class="o">@</span>
</pre></div>
</div>
</section>
<section id="side-a">
<h2>Side A<a class="headerlink" href="#side-a" title="Link to this heading"></a></h2>
<p>We will be configuring a standard route based VPN for side a. We need to create a tunnel interface, route, and tunnle.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">interfaces</span> <span class="p">{</span>
    <span class="n">vti</span> <span class="n">vti0</span> <span class="p">{</span>
        <span class="n">mtu</span> <span class="mi">1436</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">protocols</span> <span class="p">{</span>
    <span class="n">static</span> <span class="p">{</span>
        <span class="n">interface</span><span class="o">-</span><span class="n">route</span> <span class="mf">172.30.1.0</span><span class="o">/</span><span class="mi">24</span> <span class="p">{</span>
            <span class="nb">next</span><span class="o">-</span><span class="n">hop</span><span class="o">-</span><span class="n">interface</span> <span class="n">vti0</span> <span class="p">{</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">vpn</span> <span class="p">{</span>
    <span class="n">ipsec</span> <span class="p">{</span>
        <span class="n">allow</span><span class="o">-</span><span class="n">access</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">local</span><span class="o">-</span><span class="n">interface</span> <span class="n">disable</span>
        <span class="n">auto</span><span class="o">-</span><span class="n">firewall</span><span class="o">-</span><span class="n">nat</span><span class="o">-</span><span class="n">exclude</span> <span class="n">enable</span>
        <span class="n">esp</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="p">{</span>
            <span class="n">compression</span> <span class="n">disable</span>
            <span class="n">lifetime</span> <span class="mi">3600</span>
            <span class="n">mode</span> <span class="n">tunnel</span>
            <span class="n">pfs</span> <span class="n">enable</span>
            <span class="n">proposal</span> <span class="mi">1</span> <span class="p">{</span>
                <span class="n">encryption</span> <span class="n">aes128</span>
                <span class="nb">hash</span> <span class="n">sha1</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">ike</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="p">{</span>
            <span class="n">ikev2</span><span class="o">-</span><span class="n">reauth</span> <span class="n">no</span>
            <span class="n">key</span><span class="o">-</span><span class="n">exchange</span> <span class="n">ikev1</span>
            <span class="n">lifetime</span> <span class="mi">28800</span>
            <span class="n">proposal</span> <span class="mi">1</span> <span class="p">{</span>
                <span class="n">dh</span><span class="o">-</span><span class="n">group</span> <span class="mi">14</span>
                <span class="n">encryption</span> <span class="n">aes128</span>
                <span class="nb">hash</span> <span class="n">sha1</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">site</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">site</span> <span class="p">{</span>
            <span class="n">peer</span> <span class="mf">20.0.0.2</span> <span class="p">{</span>
                <span class="n">authentication</span> <span class="p">{</span>
                    <span class="n">mode</span> <span class="n">pre</span><span class="o">-</span><span class="n">shared</span><span class="o">-</span><span class="n">secret</span>
                    <span class="n">pre</span><span class="o">-</span><span class="n">shared</span><span class="o">-</span><span class="n">secret</span> <span class="mi">7</span><span class="n">raJ5QAK9cKuHR9tQeG</span><span class="o">@</span>
                <span class="p">}</span>
                <span class="n">connection</span><span class="o">-</span><span class="nb">type</span> <span class="n">initiate</span>
                <span class="n">description</span> <span class="n">ipsec</span>
                <span class="n">ike</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span>
                <span class="n">ikev2</span><span class="o">-</span><span class="n">reauth</span> <span class="n">inherit</span>
                <span class="n">local</span><span class="o">-</span><span class="n">address</span> <span class="mf">10.0.0.2</span>
                <span class="n">vti</span> <span class="p">{</span>
                    <span class="n">bind</span> <span class="n">vti0</span>
                    <span class="n">esp</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#Create tunnel interface</span>
<span class="nb">set</span> <span class="n">interfaces</span> <span class="n">vti</span> <span class="n">vti0</span> <span class="n">mtu</span> <span class="mi">1436</span>

<span class="c1">#Create route</span>
<span class="nb">set</span> <span class="n">protocols</span> <span class="n">static</span> <span class="n">interface</span><span class="o">-</span><span class="n">route</span> <span class="mf">172.30.1.0</span><span class="o">/</span><span class="mi">24</span> <span class="nb">next</span><span class="o">-</span><span class="n">hop</span><span class="o">-</span><span class="n">interface</span> <span class="n">vti0</span>

<span class="c1">#Create VPN tunnel</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">allow</span><span class="o">-</span><span class="n">access</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">local</span><span class="o">-</span><span class="n">interface</span> <span class="n">disable</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">auto</span><span class="o">-</span><span class="n">firewall</span><span class="o">-</span><span class="n">nat</span><span class="o">-</span><span class="n">exclude</span> <span class="n">enable</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">esp</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="n">compression</span> <span class="n">disable</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">esp</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="n">lifetime</span> <span class="mi">3600</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">esp</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="n">mode</span> <span class="n">tunnel</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">esp</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="n">pfs</span> <span class="n">enable</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">esp</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="n">proposal</span> <span class="mi">1</span> <span class="n">encryption</span> <span class="n">aes128</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">esp</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="n">proposal</span> <span class="mi">1</span> <span class="nb">hash</span> <span class="n">sha1</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">ike</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="n">ikev2</span><span class="o">-</span><span class="n">reauth</span> <span class="n">no</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">ike</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="n">key</span><span class="o">-</span><span class="n">exchange</span> <span class="n">ikev1</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">ike</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="n">lifetime</span> <span class="mi">28800</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">ike</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="n">proposal</span> <span class="mi">1</span> <span class="n">dh</span><span class="o">-</span><span class="n">group</span> <span class="mi">14</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">ike</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="n">proposal</span> <span class="mi">1</span> <span class="n">encryption</span> <span class="n">aes128</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">ike</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="n">proposal</span> <span class="mi">1</span> <span class="nb">hash</span> <span class="n">sha1</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">site</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">site</span> <span class="n">peer</span> <span class="mf">20.0.0.2</span> <span class="n">authentication</span> <span class="n">mode</span> <span class="n">pre</span><span class="o">-</span><span class="n">shared</span><span class="o">-</span><span class="n">secret</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">site</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">site</span> <span class="n">peer</span> <span class="mf">20.0.0.2</span> <span class="n">authentication</span> <span class="n">pre</span><span class="o">-</span><span class="n">shared</span><span class="o">-</span><span class="n">secret</span> <span class="mi">7</span><span class="n">raJ5QAK9cKuHR9tQeG</span><span class="o">@</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">site</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">site</span> <span class="n">peer</span> <span class="mf">20.0.0.2</span> <span class="n">connection</span><span class="o">-</span><span class="nb">type</span> <span class="n">initiate</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">site</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">site</span> <span class="n">peer</span> <span class="mf">20.0.0.2</span> <span class="n">description</span> <span class="n">ipsec</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">site</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">site</span> <span class="n">peer</span> <span class="mf">20.0.0.2</span> <span class="n">ike</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">site</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">site</span> <span class="n">peer</span> <span class="mf">20.0.0.2</span> <span class="n">ikev2</span><span class="o">-</span><span class="n">reauth</span> <span class="n">inherit</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">site</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">site</span> <span class="n">peer</span> <span class="mf">20.0.0.2</span> <span class="n">local</span><span class="o">-</span><span class="n">address</span> <span class="mf">10.0.0.2</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">site</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">site</span> <span class="n">peer</span> <span class="mf">20.0.0.2</span> <span class="n">vti</span> <span class="n">bind</span> <span class="n">vti0</span>
<span class="nb">set</span> <span class="n">vpn</span> <span class="n">ipsec</span> <span class="n">site</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">site</span> <span class="n">peer</span> <span class="mf">20.0.0.2</span> <span class="n">vti</span> <span class="n">esp</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span>
</pre></div>
</div>
</section>
<section id="side-b">
<h2>Side B<a class="headerlink" href="#side-b" title="Link to this heading"></a></h2>
<p>On side B we will need to setup the VPN and the PBR. VPN configuration is almost the same as above.
To create the PBR we need to setup a firewall rule, a route table, and apply it to an interface. I am going to assume interface switch0 is internal facing.</p>
<p>Setup the PBR modify rules and apply to interface switch0</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">firewall</span> <span class="p">{</span>
    <span class="n">modify</span> <span class="n">PBR</span> <span class="p">{</span>
        <span class="n">rule</span> <span class="mi">10</span> <span class="p">{</span>
            <span class="n">action</span> <span class="n">modify</span>
            <span class="n">destination</span> <span class="p">{</span>
                <span class="n">address</span> <span class="mf">192.168.10.0</span><span class="o">/</span><span class="mi">24</span>
            <span class="p">}</span>
            <span class="n">modify</span> <span class="p">{</span>
                <span class="n">table</span> <span class="mi">1</span>
            <span class="p">}</span>
            <span class="n">source</span> <span class="p">{</span>
                <span class="n">address</span> <span class="mf">172.30.1.0</span><span class="o">/</span><span class="mi">28</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">interfaces</span> <span class="p">{</span>
    <span class="n">switch</span> <span class="n">switch0</span> <span class="p">{</span>
        <span class="n">address</span> <span class="mf">172.30.1.0</span><span class="o">/</span><span class="mi">24</span>
        <span class="n">duplex</span> <span class="n">auto</span>
        <span class="n">firewall</span> <span class="p">{</span>
            <span class="ow">in</span> <span class="p">{</span>
                <span class="n">modify</span> <span class="n">PBR</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#Create firewall rules</span>
<span class="nb">set</span> <span class="n">firewall</span> <span class="n">modify</span> <span class="n">PBR</span> <span class="n">rule</span> <span class="mi">10</span> <span class="n">action</span> <span class="n">modify</span>
<span class="nb">set</span> <span class="n">firewall</span> <span class="n">modify</span> <span class="n">PBR</span> <span class="n">rule</span> <span class="mi">10</span> <span class="n">destination</span> <span class="n">address</span> <span class="mf">192.168.10.0</span><span class="o">/</span><span class="mi">24</span>
<span class="nb">set</span> <span class="n">firewall</span> <span class="n">modify</span> <span class="n">PBR</span> <span class="n">rule</span> <span class="mi">10</span> <span class="n">modify</span> <span class="n">table</span> <span class="mi">1</span>
<span class="nb">set</span> <span class="n">firewall</span> <span class="n">modify</span> <span class="n">PBR</span> <span class="n">rule</span> <span class="mi">10</span> <span class="n">source</span> <span class="n">address</span> <span class="mf">172.30.1.0</span><span class="o">/</span><span class="mi">28</span>

<span class="c1">#Add rule to interface</span>
<span class="nb">set</span> <span class="n">interfaces</span> <span class="n">switch</span> <span class="n">switch0</span> <span class="n">firewall</span> <span class="ow">in</span> <span class="n">modify</span> <span class="n">PBR</span>
</pre></div>
</div>
<p>Setup the VPN tunnel</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">interfaces</span> <span class="p">{</span>
    <span class="n">vti</span> <span class="n">vti0</span> <span class="p">{</span>
        <span class="n">mtu</span> <span class="mi">1436</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">protocols</span> <span class="p">{</span>
    <span class="n">static</span> <span class="p">{</span>
        <span class="n">table</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="n">interface</span><span class="o">-</span><span class="n">route</span> <span class="mf">192.168.10.0</span><span class="o">/</span><span class="mi">24</span> <span class="p">{</span>
                <span class="nb">next</span><span class="o">-</span><span class="n">hop</span><span class="o">-</span><span class="n">interface</span> <span class="n">vti0</span> <span class="p">{</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">vpn</span> <span class="p">{</span>
    <span class="n">ipsec</span> <span class="p">{</span>
        <span class="n">allow</span><span class="o">-</span><span class="n">access</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">local</span><span class="o">-</span><span class="n">interface</span> <span class="n">disable</span>
        <span class="n">auto</span><span class="o">-</span><span class="n">firewall</span><span class="o">-</span><span class="n">nat</span><span class="o">-</span><span class="n">exclude</span> <span class="n">enable</span>
        <span class="n">esp</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="p">{</span>
            <span class="n">compression</span> <span class="n">disable</span>
            <span class="n">lifetime</span> <span class="mi">3600</span>
            <span class="n">mode</span> <span class="n">tunnel</span>
            <span class="n">pfs</span> <span class="n">enable</span>
            <span class="n">proposal</span> <span class="mi">1</span> <span class="p">{</span>
                <span class="n">encryption</span> <span class="n">aes128</span>
                <span class="nb">hash</span> <span class="n">sha1</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">ike</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="p">{</span>
            <span class="n">ikev2</span><span class="o">-</span><span class="n">reauth</span> <span class="n">no</span>
            <span class="n">key</span><span class="o">-</span><span class="n">exchange</span> <span class="n">ikev1</span>
            <span class="n">lifetime</span> <span class="mi">28800</span>
            <span class="n">proposal</span> <span class="mi">1</span> <span class="p">{</span>
                <span class="n">dh</span><span class="o">-</span><span class="n">group</span> <span class="mi">14</span>
                <span class="n">encryption</span> <span class="n">aes128</span>
                <span class="nb">hash</span> <span class="n">sha1</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">site</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">site</span> <span class="p">{</span>
            <span class="n">peer</span> <span class="mf">10.0.0.2</span> <span class="p">{</span>
                <span class="n">authentication</span> <span class="p">{</span>
                    <span class="n">mode</span> <span class="n">pre</span><span class="o">-</span><span class="n">shared</span><span class="o">-</span><span class="n">secret</span>
                    <span class="n">pre</span><span class="o">-</span><span class="n">shared</span><span class="o">-</span><span class="n">secret</span> <span class="mi">7</span><span class="n">raJ5QAK9cKuHR9tQeG</span><span class="o">@</span>
                <span class="p">}</span>
                <span class="n">connection</span><span class="o">-</span><span class="nb">type</span> <span class="n">initiate</span>
                <span class="n">description</span> <span class="n">ipsec</span>
                <span class="n">ike</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span>
                <span class="n">ikev2</span><span class="o">-</span><span class="n">reauth</span> <span class="n">inherit</span>
                <span class="n">local</span><span class="o">-</span><span class="n">address</span> <span class="mf">20.0.0.2</span>
                <span class="n">vti</span> <span class="p">{</span>
                    <span class="n">bind</span> <span class="n">vti0</span>
                    <span class="n">esp</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#Create tunnel interface
set interfaces vti vti0 mtu 1436

#Create table 1
set protocols static table 1 interface-route 192.168.10.0/24 next-hop-interface vti0

#Create VPN tunnel
set vpn ipsec allow-access-to-local-interface disable
set vpn ipsec auto-firewall-nat-exclude enable
set vpn ipsec esp-group FOO0 compression disable
set vpn ipsec esp-group FOO0 lifetime 3600
set vpn ipsec esp-group FOO0 mode tunnel
set vpn ipsec esp-group FOO0 pfs enable
set vpn ipsec esp-group FOO0 proposal 1 encryption aes128
set vpn ipsec esp-group FOO0 proposal 1 hash sha1
set vpn ipsec ike-group FOO0 ikev2-reauth no
set vpn ipsec ike-group FOO0 key-exchange ikev1
set vpn ipsec ike-group FOO0 lifetime 28800
set vpn ipsec ike-group FOO0 proposal 1 dh-group 14
set vpn ipsec ike-group FOO0 proposal 1 encryption aes128
set vpn ipsec ike-group FOO0 proposal 1 hash sha1
set vpn ipsec site-to-site peer 10.0.0.2 authentication mode pre-shared-secret
set vpn ipsec site-to-site peer 10.0.0.2 authentication pre-shared-secret JmEjBXdk9kUA96!r#Hkb
set vpn ipsec site-to-site peer 10.0.0.2 connection-type initiate
set vpn ipsec site-to-site peer 10.0.0.2 description ipsec
set vpn ipsec site-to-site peer 10.0.0.2 ike-group FOO0
set vpn ipsec site-to-site peer 10.0.0.2 ikev2-reauth inherit
set vpn ipsec site-to-site peer 10.0.0.2 local-address 20.0.0.2
set vpn ipsec site-to-site peer 10.0.0.2 vti bind vti0
set vpn ipsec site-to-site peer 10.0.0.2 vti esp-group FOO0
</pre></div>
</div>
</section>
<section id="side-b-complete-config">
<h2>Side B complete config<a class="headerlink" href="#side-b-complete-config" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">firewall</span> <span class="p">{</span>
    <span class="n">modify</span> <span class="n">PBR</span> <span class="p">{</span>
        <span class="n">rule</span> <span class="mi">10</span> <span class="p">{</span>
            <span class="n">action</span> <span class="n">modify</span>
            <span class="n">destination</span> <span class="p">{</span>
                <span class="n">address</span> <span class="mf">192.168.10.0</span><span class="o">/</span><span class="mi">24</span>
            <span class="p">}</span>
            <span class="n">modify</span> <span class="p">{</span>
                <span class="n">table</span> <span class="mi">1</span>
            <span class="p">}</span>
            <span class="n">source</span> <span class="p">{</span>
                <span class="n">address</span> <span class="mf">172.30.1.0</span><span class="o">/</span><span class="mi">28</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">interfaces</span> <span class="p">{</span>
    <span class="n">switch</span> <span class="n">switch0</span> <span class="p">{</span>
        <span class="n">address</span> <span class="mf">172.30.1.0</span><span class="o">/</span><span class="mi">24</span>
        <span class="n">duplex</span> <span class="n">auto</span>
        <span class="n">firewall</span> <span class="p">{</span>
            <span class="ow">in</span> <span class="p">{</span>
                <span class="n">modify</span> <span class="n">PBR</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">vti</span> <span class="n">vti0</span> <span class="p">{</span>
        <span class="n">mtu</span> <span class="mi">1436</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">protocols</span> <span class="p">{</span>
    <span class="n">static</span> <span class="p">{</span>
        <span class="n">table</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="n">interface</span><span class="o">-</span><span class="n">route</span> <span class="mf">192.168.10.0</span><span class="o">/</span><span class="mi">24</span> <span class="p">{</span>
                <span class="nb">next</span><span class="o">-</span><span class="n">hop</span><span class="o">-</span><span class="n">interface</span> <span class="n">vti0</span> <span class="p">{</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">vpn</span> <span class="p">{</span>
    <span class="n">ipsec</span> <span class="p">{</span>
        <span class="n">allow</span><span class="o">-</span><span class="n">access</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">local</span><span class="o">-</span><span class="n">interface</span> <span class="n">disable</span>
        <span class="n">auto</span><span class="o">-</span><span class="n">firewall</span><span class="o">-</span><span class="n">nat</span><span class="o">-</span><span class="n">exclude</span> <span class="n">enable</span>
        <span class="n">esp</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="p">{</span>
            <span class="n">compression</span> <span class="n">disable</span>
            <span class="n">lifetime</span> <span class="mi">3600</span>
            <span class="n">mode</span> <span class="n">tunnel</span>
            <span class="n">pfs</span> <span class="n">enable</span>
            <span class="n">proposal</span> <span class="mi">1</span> <span class="p">{</span>
                <span class="n">encryption</span> <span class="n">aes128</span>
                <span class="nb">hash</span> <span class="n">sha1</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">ike</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span> <span class="p">{</span>
            <span class="n">ikev2</span><span class="o">-</span><span class="n">reauth</span> <span class="n">no</span>
            <span class="n">key</span><span class="o">-</span><span class="n">exchange</span> <span class="n">ikev1</span>
            <span class="n">lifetime</span> <span class="mi">28800</span>
            <span class="n">proposal</span> <span class="mi">1</span> <span class="p">{</span>
                <span class="n">dh</span><span class="o">-</span><span class="n">group</span> <span class="mi">14</span>
                <span class="n">encryption</span> <span class="n">aes128</span>
                <span class="nb">hash</span> <span class="n">sha1</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">site</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">site</span> <span class="p">{</span>
            <span class="n">peer</span> <span class="mf">10.0.0.2</span> <span class="p">{</span>
                <span class="n">authentication</span> <span class="p">{</span>
                    <span class="n">mode</span> <span class="n">pre</span><span class="o">-</span><span class="n">shared</span><span class="o">-</span><span class="n">secret</span>
                    <span class="n">pre</span><span class="o">-</span><span class="n">shared</span><span class="o">-</span><span class="n">secret</span> <span class="mi">7</span><span class="n">raJ5QAK9cKuHR9tQeG</span><span class="o">@</span>
                <span class="p">}</span>
                <span class="n">connection</span><span class="o">-</span><span class="nb">type</span> <span class="n">initiate</span>
                <span class="n">description</span> <span class="n">ipsec</span>
                <span class="n">ike</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span>
                <span class="n">ikev2</span><span class="o">-</span><span class="n">reauth</span> <span class="n">inherit</span>
                <span class="n">local</span><span class="o">-</span><span class="n">address</span> <span class="mf">20.0.0.2</span>
                <span class="n">vti</span> <span class="p">{</span>
                    <span class="n">bind</span> <span class="n">vti0</span>
                    <span class="n">esp</span><span class="o">-</span><span class="n">group</span> <span class="n">FOO0</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#Create firewall rules
set firewall modify PBR rule 10 action modify
set firewall modify PBR rule 10 destination address 192.168.10.0/24
set firewall modify PBR rule 10 modify table 1
set firewall modify PBR rule 10 source address 172.30.1.0/28

#Add rule to interface
set interfaces switch switch0 firewall in modify PBR

#Create tunnel interface
set interfaces vti vti0 mtu 1436

#Create table 1
set protocols static table 1 interface-route 192.168.10.0/24 next-hop-interface vti0

#Create VPN tunnel
set vpn ipsec allow-access-to-local-interface disable
set vpn ipsec auto-firewall-nat-exclude enable
set vpn ipsec esp-group FOO0 compression disable
set vpn ipsec esp-group FOO0 lifetime 3600
set vpn ipsec esp-group FOO0 mode tunnel
set vpn ipsec esp-group FOO0 pfs enable
set vpn ipsec esp-group FOO0 proposal 1 encryption aes128
set vpn ipsec esp-group FOO0 proposal 1 hash sha1
set vpn ipsec ike-group FOO0 ikev2-reauth no
set vpn ipsec ike-group FOO0 key-exchange ikev1
set vpn ipsec ike-group FOO0 lifetime 28800
set vpn ipsec ike-group FOO0 proposal 1 dh-group 14
set vpn ipsec ike-group FOO0 proposal 1 encryption aes128
set vpn ipsec ike-group FOO0 proposal 1 hash sha1
set vpn ipsec site-to-site peer 10.0.0.2 authentication mode pre-shared-secret
set vpn ipsec site-to-site peer 10.0.0.2 authentication pre-shared-secret JmEjBXdk9kUA96!r#Hkb
set vpn ipsec site-to-site peer 10.0.0.2 connection-type initiate
set vpn ipsec site-to-site peer 10.0.0.2 description ipsec
set vpn ipsec site-to-site peer 10.0.0.2 ike-group FOO0
set vpn ipsec site-to-site peer 10.0.0.2 ikev2-reauth inherit
set vpn ipsec site-to-site peer 10.0.0.2 local-address 20.0.0.2
set vpn ipsec site-to-site peer 10.0.0.2 vti bind vti0
set vpn ipsec site-to-site peer 10.0.0.2 vti esp-group FOO0
</pre></div>
</div>
</section>
<section id="resources">
<h2>Resources<a class="headerlink" href="#resources" title="Link to this heading"></a></h2>
<p>This should be all you need. If traffic is not passing try rebooting either or both routers.</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://help.ui.com/hc/en-us/articles/115011377588-EdgeRouter-Route-Based-Site-to-Site-IPsec-VPN">EdgeRouter - Route-Based Site-to-Site IPsec VPN</a></p></li>
<li><p><a class="reference external" href="https://help.ui.com/hc/en-us/articles/204952274-EdgeRouter-Policy-Based-Routing">EdgeRouter - Policy-Based Routing</a></p></li>
</ul>
</div></blockquote>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="fortissl.html" class="btn btn-neutral float-left" title="Troubleshoot Fortigate IPsec VPN" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../unixArticles/windowsKVM.html" class="btn btn-neutral float-right" title="Boot windows as KVM on serprate HDD" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">Last updated on Mar 14, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>